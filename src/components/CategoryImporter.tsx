/**
 * CategoryImporter Component
 *
 * Allows users to import category data from JSON files (generated by scripts/parse_pptx.py)
 * and review/edit the data before adding it to the application.
 */

import { useState } from 'react';
import type { Category } from '@types';
import { loadCategoryJSON, JSONImportError } from '@utils/jsonImport';

interface CategoryImporterProps {
  onImport: (contestantName: string, category: Category) => void;
  onCancel: () => void;
}

export function CategoryImporter({ onImport, onCancel }: CategoryImporterProps) {
  const [file, setFile] = useState<File | null>(null);
  const [category, setCategory] = useState<Category | null>(null);
  const [contestantName, setContestantName] = useState('');
  const [categoryName, setCategoryName] = useState('');
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [expandedSlides, setExpandedSlides] = useState<Set<number>>(new Set());

  const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = event.target.files?.[0];

    if (!selectedFile) {
      return;
    }

    setFile(selectedFile);
    setError(null);
    setIsLoading(true);

    try {
      const loadedCategory = await loadCategoryJSON(selectedFile);
      setCategory(loadedCategory);
      setCategoryName(loadedCategory.name);

      // Try to extract contestant name from filename (e.g., "john-movies.json" -> "John")
      const fileNameWithoutExt = selectedFile.name.replace(/\.json$/i, '');
      const parts = fileNameWithoutExt.split('-');
      if (parts.length > 0 && parts[0]) {
        const name = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
        setContestantName(name);
      }
    } catch (err) {
      if (err instanceof JSONImportError) {
        setError(err.message);
      } else {
        setError('An unexpected error occurred while loading the file');
      }
      setCategory(null);
    } finally {
      setIsLoading(false);
    }
  };

  const handleSlideAnswerChange = (slideIndex: number, newAnswer: string) => {
    if (!category) {
      return;
    }

    const updatedSlides = category.slides.map((slide, index) =>
      index === slideIndex ? { ...slide, answer: newAnswer } : slide
    );

    setCategory({
      ...category,
      slides: updatedSlides,
    });
  };

  const toggleSlideExpanded = (slideIndex: number) => {
    setExpandedSlides((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(slideIndex)) {
        newSet.delete(slideIndex);
      } else {
        newSet.add(slideIndex);
      }
      return newSet;
    });
  };

  const handleImport = () => {
    if (!category) {
      return;
    }

    try {
      // Use the edited category name if changed
      const finalCategory: Category = {
        ...category,
        name: categoryName.trim() || category.name,
      };

      const finalContestantName = contestantName.trim();

      if (!finalContestantName) {
        setError('Contestant name is required');
        return;
      }

      onImport(finalContestantName, finalCategory);
    } catch (err) {
      if (err instanceof JSONImportError) {
        setError(err.message);
      } else {
        setError('An unexpected error occurred during import');
      }
    }
  };

  return (
    <div className="category-importer">
      <h2>Import Category from JSON</h2>

      <div className="file-upload-section">
        <label htmlFor="json-file-input">Select JSON file:</label>
        <input
          id="json-file-input"
          type="file"
          accept=".json,application/json"
          onChange={(e) => {
            void handleFileChange(e);
          }}
          disabled={isLoading}
        />
        {file && <p className="file-name">Selected: {file.name}</p>}
      </div>

      {isLoading && <p className="loading">Loading and validating...</p>}

      {error && (
        <div className="error-message" role="alert">
          <strong>Error:</strong> {error}
        </div>
      )}

      {category && !isLoading && (
        <div className="preview-section">
          <h3>Preview</h3>

          <div className="form-group">
            <label htmlFor="contestant-name-input">Contestant Name:</label>
            <input
              id="contestant-name-input"
              type="text"
              value={contestantName}
              onChange={(e) => {
                setContestantName(e.target.value);
              }}
              placeholder="Enter contestant name"
              required
            />
          </div>

          <div className="form-group">
            <label htmlFor="category-name-input">Category Name:</label>
            <input
              id="category-name-input"
              type="text"
              value={categoryName}
              onChange={(e) => {
                setCategoryName(e.target.value);
              }}
              placeholder="Enter category name"
              required
            />
          </div>

          <div className="slides-summary">
            <h4>Slides: {category.slides.length}</h4>
            <p style={{ fontSize: '0.9rem', color: '#666', marginBottom: '1rem' }}>
              Click on any slide to expand and edit its answer. Censor boxes are displayed for
              reference.
            </p>
            <div className="slides-list">
              {category.slides.map((slide, index) => {
                const isExpanded = expandedSlides.has(index);
                return (
                  <div
                    key={index}
                    className="slide-item"
                    style={{
                      border: '1px solid #ddd',
                      borderRadius: '4px',
                      padding: '1rem',
                      marginBottom: '0.5rem',
                      backgroundColor: isExpanded ? '#f9f9f9' : 'white',
                    }}
                  >
                    <div
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '1rem',
                        cursor: 'pointer',
                      }}
                      onClick={() => {
                        toggleSlideExpanded(index);
                      }}
                    >
                      <img
                        src={slide.imageUrl}
                        alt={`Slide ${String(index + 1)}`}
                        style={{
                          width: '100px',
                          height: '75px',
                          objectFit: 'cover',
                          borderRadius: '2px',
                        }}
                      />
                      <div style={{ flex: 1 }}>
                        <strong>Slide {index + 1}</strong>
                        <p style={{ margin: '0.25rem 0', fontSize: '0.9rem' }}>
                          {slide.answer || '(no answer)'}
                        </p>
                        <p style={{ margin: 0, fontSize: '0.85rem', color: '#666' }}>
                          {slide.censorBoxes.length} censor box
                          {slide.censorBoxes.length !== 1 ? 'es' : ''}
                        </p>
                      </div>
                      <span style={{ fontSize: '1.2rem' }}>{isExpanded ? '▼' : '▶'}</span>
                    </div>

                    {isExpanded && (
                      <div
                        style={{ marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid #ddd' }}
                      >
                        <div style={{ marginBottom: '1rem', position: 'relative', display: 'inline-block' }}>
                          <img
                            src={slide.imageUrl}
                            alt={`Slide ${String(index + 1)} full`}
                            style={{
                              maxWidth: '100%',
                              height: 'auto',
                              borderRadius: '4px',
                              border: '1px solid #ccc',
                              display: 'block',
                            }}
                          />
                          {/* Render censor boxes as overlays */}
                          {slide.censorBoxes.map((box, boxIndex) => (
                            <div
                              key={boxIndex}
                              style={{
                                position: 'absolute',
                                left: `${box.x}%`,
                                top: `${box.y}%`,
                                width: `${box.width}%`,
                                height: `${box.height}%`,
                                backgroundColor: box.color,
                                border: '2px solid rgba(255, 255, 255, 0.5)',
                                boxShadow: '0 0 4px rgba(0, 0, 0, 0.3)',
                                pointerEvents: 'none',
                              }}
                              title={`Censor Box ${boxIndex + 1}: ${box.x.toFixed(1)}%, ${box.y.toFixed(1)}%`}
                            />
                          ))}
                        </div>

                        <div className="form-group">
                          <label htmlFor={`slide-answer-${String(index)}`}>
                            <strong>Answer:</strong>
                          </label>
                          <input
                            id={`slide-answer-${String(index)}`}
                            type="text"
                            value={slide.answer}
                            onChange={(e) => {
                              handleSlideAnswerChange(index, e.target.value);
                            }}
                            placeholder="Enter answer for this slide"
                            style={{
                              width: '100%',
                              padding: '0.5rem',
                              fontSize: '1rem',
                              border: '1px solid #ccc',
                              borderRadius: '4px',
                            }}
                            onClick={(e) => {
                              e.stopPropagation();
                            }}
                          />
                        </div>

                        {slide.censorBoxes.length > 0 && (
                          <div style={{ marginTop: '1rem' }}>
                            <strong>Censor Boxes ({slide.censorBoxes.length}):</strong>
                            <ul style={{ marginTop: '0.5rem', fontSize: '0.85rem' }}>
                              {slide.censorBoxes.map((box, boxIndex) => (
                                <li key={boxIndex}>
                                  <strong>Box {boxIndex + 1}:</strong> Position: ({box.x.toFixed(1)}%,{' '}
                                  {box.y.toFixed(1)}%), Size: ({box.width.toFixed(1)}% ×{' '}
                                  {box.height.toFixed(1)}%), Color:{' '}
                                  <span
                                    style={{
                                      display: 'inline-block',
                                      width: '16px',
                                      height: '16px',
                                      backgroundColor: box.color,
                                      border: '1px solid #000',
                                      verticalAlign: 'middle',
                                      marginLeft: '4px',
                                    }}
                                  ></span>{' '}
                                  {box.color}
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>

          <div className="actions">
            <button
              type="button"
              onClick={handleImport}
              disabled={!contestantName.trim() || !categoryName.trim()}
              className="import-button"
            >
              Import
            </button>
            <button type="button" onClick={onCancel} className="cancel-button">
              Cancel
            </button>
          </div>
        </div>
      )}

      {!category && !isLoading && !error && (
        <div className="actions">
          <button type="button" onClick={onCancel} className="cancel-button">
            Cancel
          </button>
        </div>
      )}
    </div>
  );
}
